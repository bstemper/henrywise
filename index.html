<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UK Tax Calculator</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --white:   #ffffff;
  --gray-50: #f9fafb;
  --gray-100:#f3f4f6;
  --gray-200:#e5e7eb;
  --gray-300:#d1d5db;
  --gray-400:#9ca3af;
  --gray-500:#6b7280;
  --gray-600:#4b5563;
  --gray-700:#374151;
  --gray-800:#1f2937;
  --gray-900:#111827;

  --blue-50:  #eff6ff;
  --blue-100: #dbeafe;
  --blue-500: #3b82f6;
  --blue-600: #2563eb;
  --blue-700: #1d4ed8;

  --green-50:  #f0fdf4;
  --green-100: #dcfce7;
  --green-600: #16a34a;
  --green-700: #15803d;

  --amber-50:  #fffbeb;
  --amber-100: #fef3c7;
  --amber-600: #d97706;

  --radius-sm: 6px;
  --radius:    10px;
  --radius-lg: 14px;
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
  --shadow:    0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
  --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
  --col-w: 200px;
  --label-w: 220px;
}

body {
  font-family: 'Inter', system-ui, sans-serif;
  background: var(--gray-50);
  color: var(--gray-900);
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
}

.page {
  max-width: 1200px;
  margin: 0 auto;
  padding: 48px 32px 80px;
}

/* ── Header ─────────────────────────────────── */
.page-header {
  margin-bottom: 36px;
}
.page-header h1 {
  font-size: 1.875rem;
  font-weight: 600;
  letter-spacing: -0.025em;
  color: var(--gray-900);
  line-height: 1.2;
}
.page-header p {
  margin-top: 6px;
  font-size: 0.875rem;
  color: var(--gray-500);
}

/* ── Toolbar ─────────────────────────────────── */
.toolbar {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.select-wrap {
  display: flex;
  align-items: center;
  gap: 8px;
  background: var(--white);
  border: 1px solid var(--gray-200);
  border-radius: var(--radius);
  padding: 0 12px;
  height: 38px;
  box-shadow: var(--shadow-sm);
}
.select-wrap label {
  font-size: 0.75rem;
  font-weight: 500;
  color: var(--gray-500);
  white-space: nowrap;
}
.select-wrap select {
  background: none;
  border: none;
  font-family: inherit;
  font-size: 0.875rem;
  font-weight: 500;
  color: var(--gray-800);
  outline: none;
  cursor: pointer;
}

/* ── Buttons ─────────────────────────────────── */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-family: inherit;
  font-size: 0.875rem;
  font-weight: 500;
  border-radius: var(--radius);
  border: none;
  cursor: pointer;
  padding: 0 16px;
  height: 38px;
  transition: background 0.15s, box-shadow 0.15s, transform 0.1s;
  white-space: nowrap;
}
.btn:active { transform: scale(0.98); }

.btn-primary {
  background: var(--gray-900);
  color: #fff;
  box-shadow: var(--shadow-sm);
}
.btn-primary:hover { background: var(--gray-700); }

.btn-outline {
  background: var(--white);
  color: var(--gray-700);
  border: 1px solid var(--gray-200);
  box-shadow: var(--shadow-sm);
}
.btn-outline:hover { background: var(--gray-50); border-color: var(--gray-300); }

.btn-ghost {
  background: transparent;
  color: var(--gray-500);
  border: 1px dashed var(--gray-300);
}
.btn-ghost:hover { background: var(--gray-100); color: var(--gray-700); }

.btn-danger {
  background: none;
  border: none;
  color: var(--gray-400);
  cursor: pointer;
  font-size: 0.75rem;
  font-family: inherit;
  padding: 2px 6px;
  border-radius: var(--radius-sm);
  transition: color 0.15s, background 0.15s;
}
.btn-danger:hover { color: #dc2626; background: #fef2f2; }

/* ── Table wrapper ─────────────────────────────────── */
.table-scroll {
  overflow-x: auto;
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-md);
}

.calc-grid {
  display: grid;
  /* label col + data cols; set via JS inline style */
  background: var(--white);
  border: 1px solid var(--gray-200);
  border-radius: var(--radius-lg);
  overflow: hidden;
  min-width: fit-content;
  width: fit-content;
}

/* ── Cells ─────────────────────────────────── */
.cell {
  display: flex;
  align-items: center;
  padding: 0 18px;
  min-height: 48px;
  border-bottom: 1px solid var(--gray-100);
  border-right: 1px solid var(--gray-100);
  font-size: 0.875rem;
}
.cell.no-border-right { border-right: none; }
.cell.no-border-bottom { border-bottom: none; }

/* column header */
.cell-colhead {
  background: var(--gray-50);
  min-height: 52px;
  justify-content: space-between;
  align-items: center;
  gap: 6px;
  border-bottom: 1px solid var(--gray-200);
  border-right: 1px solid var(--gray-100);
}
.cell-colhead.label-col {
  justify-content: flex-start;
}

/* section row */
.cell-section {
  background: var(--gray-50);
  min-height: 36px;
  border-bottom: 1px solid var(--gray-200);
}
.cell-section.label-col {
  cursor: pointer;
  user-select: none;
  gap: 8px;
  transition: background 0.12s;
}
.cell-section.label-col:hover { background: var(--gray-100); }
.cell-section.value-col {
  background: var(--gray-50);
}

/* input row */
.cell-input { min-height: 56px; padding: 8px 12px; }

/* band row */
.cell-band { min-height: 40px; background: var(--gray-50); }
.cell-band.label-col { padding-left: 36px; color: var(--gray-500); font-size: 0.8125rem; }

.cell-niband { min-height: 40px; background: var(--amber-50); }
.cell-niband.label-col { padding-left: 36px; color: var(--amber-600); font-size: 0.8125rem; }

.cell-taxband { min-height: 40px; background: var(--blue-50); }
.cell-taxband.label-col { padding-left: 36px; color: var(--blue-600); font-size: 0.8125rem; }

/* total rows */
.cell-total { min-height: 52px; font-weight: 500; }
.cell-total.label-col { font-size: 0.875rem; color: var(--gray-700); }

.cell-takehome { min-height: 60px; border-top: 2px solid var(--gray-200); }
.cell-takehome.label-col { font-size: 0.9375rem; font-weight: 600; color: var(--gray-900); }

.cell-monthly { min-height: 38px; }
.cell-monthly.label-col { padding-left: 30px; font-size: 0.8125rem; color: var(--gray-400); }

/* label column text */
.cell.label-col { color: var(--gray-600); font-size: 0.875rem; }

/* value cells */
.cell.value-col {
  justify-content: flex-end;
  font-variant-numeric: tabular-nums;
  color: var(--gray-600);
}
.cell-total.value-col { color: var(--blue-600); }
.cell-total.value-col.ni { color: var(--amber-600); }
.cell-takehome.value-col { font-size: 1rem; font-weight: 600; color: var(--gray-900); }
.cell-monthly.value-col  { color: var(--gray-400); font-size: 0.8125rem; }
.cell-taxband.value-col  { color: var(--blue-500); }
.cell-niband.value-col   { color: var(--amber-600); }

/* pending state (not yet calculated) */
.cell.pending { color: var(--gray-300); }

/* ── Input field ─────────────────────────────────── */
.field {
  display: flex;
  align-items: center;
  width: 100%;
  background: var(--white);
  border: 1px solid var(--gray-200);
  border-radius: var(--radius);
  overflow: hidden;
  transition: border-color 0.15s, box-shadow 0.15s;
  box-shadow: var(--shadow-sm);
}
.field:focus-within {
  border-color: var(--blue-500);
  box-shadow: 0 0 0 3px rgba(59,130,246,0.15);
}
.field-pfx {
  padding: 0 10px;
  font-size: 0.875rem;
  color: var(--gray-400);
  background: var(--gray-50);
  align-self: stretch;
  display: flex;
  align-items: center;
  border-right: 1px solid var(--gray-200);
  flex-shrink: 0;
}
.field input {
  flex: 1;
  border: none;
  background: none;
  font-family: inherit;
  font-size: 0.875rem;
  color: var(--gray-900);
  padding: 10px 10px;
  outline: none;
  min-width: 0;
}
.field input::placeholder { color: var(--gray-300); }

/* ── Toggle chevron ─────────────────────────────────── */
.chevron {
  width: 16px;
  height: 16px;
  flex-shrink: 0;
  color: var(--gray-400);
  transition: transform 0.2s;
}
.chevron.open { transform: rotate(90deg); }

/* ── Column header controls ─────────────────────────────────── */
.col-num {
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--gray-400);
  letter-spacing: 0.06em;
  text-transform: uppercase;
}

/* ── Badges ─────────────────────────────────── */
.badge {
  display: inline-flex;
  align-items: center;
  font-size: 0.6875rem;
  font-weight: 500;
  padding: 2px 7px;
  border-radius: 999px;
}
.badge-blue { background: var(--blue-100); color: var(--blue-700); }
.badge-green { background: var(--green-100); color: var(--green-700); }

/* ── Calculate button area ─────────────────────────────────── */
.calc-action {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-top: 20px;
}
.calc-note {
  font-size: 0.8125rem;
  color: var(--gray-400);
}

/* ── Result pending overlay ─────────────────────────────────── */
.result-dash {
  color: var(--gray-200);
  font-size: 0.875rem;
}

/* ── Disclaimer ─────────────────────────────────── */
.disclaimer {
  margin-top: 24px;
  padding: 12px 16px;
  background: var(--gray-100);
  border-radius: var(--radius);
  font-size: 0.75rem;
  color: var(--gray-500);
  line-height: 1.7;
  max-width: 800px;
}

/* ── Animations ─────────────────────────────────── */
@keyframes fadeSlide {
  from { opacity: 0; transform: translateY(8px); }
  to   { opacity: 1; transform: translateY(0); }
}
.results-appear { animation: fadeSlide 0.25s ease; }
</style>
</head>
<body>
<div class="page">

  <header class="page-header">
    <h1>UK Tax Calculator</h1>
    <p>Estimate your take-home pay under PAYE — England, Wales &amp; Northern Ireland</p>
  </header>

  <div class="toolbar">
    <div class="select-wrap">
      <label>Tax year</label>
      <select id="taxYear">
        <option value="2526" selected>2025–26</option>
        <option value="2627">2026–27</option>
      </select>
    </div>
  </div>

  <div class="table-scroll">
    <div class="calc-grid" id="grid"></div>
  </div>

  <div class="calc-action">
    <button class="btn btn-primary" id="calcBtn" onclick="calculate()">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
      Calculate
    </button>
    <span class="calc-note" id="calcNote">Enter your details above, then press Calculate.</span>
  </div>

  <p class="disclaimer">
    Assumes standard PAYE with no student loans, pension contributions, or salary sacrifice. Personal allowance tapers £1 for every £2 earned above £100,000.
    2026–27 rates are projected based on current government policy — verify before relying on them. Results are estimates only and do not constitute financial advice.
  </p>

</div>

<script>
// ── Tax data ──────────────────────────────────────────────────────────────────
const YEARS = {
  '2526': {
    pa: 12570,
    tax: [
      { label: 'Personal allowance (0%)',  rate: 0,    lo: 0,      hi: 12570 },
      { label: 'Basic rate · 20%',         rate: 0.20, lo: 12570,  hi: 50270 },
      { label: 'Higher rate · 40%',        rate: 0.40, lo: 50270,  hi: 125140 },
      { label: 'Additional rate · 45%',    rate: 0.45, lo: 125140, hi: Infinity },
    ],
    ni: [
      { label: 'Below threshold · 0%',     rate: 0,    lo: 0,      hi: 12570 },
      { label: 'Primary rate · 8%',        rate: 0.08, lo: 12570,  hi: 50270 },
      { label: 'Above upper limit · 2%',   rate: 0.02, lo: 50270,  hi: Infinity },
    ],
  },
  '2627': {
    pa: 12570,
    tax: [
      { label: 'Personal allowance (0%)',  rate: 0,    lo: 0,      hi: 12570 },
      { label: 'Basic rate · 20%',         rate: 0.20, lo: 12570,  hi: 50270 },
      { label: 'Higher rate · 40%',        rate: 0.40, lo: 50270,  hi: 125140 },
      { label: 'Additional rate · 45%',    rate: 0.45, lo: 125140, hi: Infinity },
    ],
    ni: [
      { label: 'Below threshold · 0%',     rate: 0,    lo: 0,      hi: 12570 },
      { label: 'Primary rate · 8%',        rate: 0.08, lo: 12570,  hi: 50270 },
      { label: 'Above upper limit · 2%',   rate: 0.02, lo: 50270,  hi: Infinity },
    ],
  },
};

// ── State ─────────────────────────────────────────────────────────────────────
const MAX_COLS = 5;
const S = {
  cols: [{ salary: '', taxCode: '1257L' }],  // start with 1 column
  taxOpen: false,
  niOpen: false,
  results: null,   // null = not yet calculated
};

// ── Tax code parser ───────────────────────────────────────────────────────────
function parseCode(code, basePa, salary) {
  code = (code || '1257L').toUpperCase().trim();
  const suffix = code.replace(/\d/g, '');
  const n = parseInt(code.replace(/\D/g, ''), 10);
  if (suffix === 'NT') return { pa: Infinity, mode: 'NT' };
  if (suffix === 'BR') return { pa: 0,        mode: 'BR' };
  if (suffix === 'D0') return { pa: 0,        mode: 'D0' };
  if (suffix === 'D1') return { pa: 0,        mode: 'D1' };
  if (suffix === 'K')  return { pa: -(n * 10), mode: 'K' };
  let pa = isNaN(n) ? basePa : n * 10;
  if (suffix === 'M') pa += 1260;
  if (suffix === 'N') pa -= 1260;
  if (salary > 100000 && pa > 0)
    pa = Math.max(0, pa - Math.floor((salary - 100000) / 2));
  return { pa, mode: 'normal' };
}

// ── Calculation ───────────────────────────────────────────────────────────────
function calcOne(salary, taxCode, yearKey) {
  if (!salary || salary <= 0) return null;
  const yr = YEARS[yearKey];
  const { pa, mode } = parseCode(taxCode, yr.pa, salary);

  let taxBands;
  if (mode === 'BR') {
    taxBands = [{ label: 'Basic rate · 20%',       rate: 0.20, lo: 0, hi: Infinity }];
  } else if (mode === 'D0') {
    taxBands = [{ label: 'Higher rate · 40%',      rate: 0.40, lo: 0, hi: Infinity }];
  } else if (mode === 'D1') {
    taxBands = [{ label: 'Additional rate · 45%',  rate: 0.45, lo: 0, hi: Infinity }];
  } else if (mode === 'NT') {
    taxBands = [{ label: 'No tax',                 rate: 0,    lo: 0, hi: Infinity }];
  } else {
    const shift = (mode === 'K') ? 0 : pa - yr.pa;
    const extra = (mode === 'K') ? Math.abs(pa) : 0;
    taxBands = yr.tax.map(b => ({
      ...b,
      lo: Math.max(0, b.lo + shift + extra),
      hi: b.hi === Infinity ? Infinity : Math.max(0, b.hi + shift + extra),
    }));
  }

  const taxBreakdown = taxBands.map(b => {
    const taxable = Math.max(0, Math.min(salary, b.hi) - b.lo);
    return { label: b.label, amount: taxable * b.rate };
  });
  const niBreakdown = yr.ni.map(b => {
    const niable = Math.max(0, Math.min(salary, b.hi) - b.lo);
    return { label: b.label, amount: niable * b.rate };
  });
  const totalTax = taxBreakdown.reduce((s, b) => s + b.amount, 0);
  const totalNI  = niBreakdown.reduce((s, b) => s + b.amount, 0);
  return { salary, totalTax, totalNI, takeHome: salary - totalTax - totalNI, taxBreakdown, niBreakdown };
}

// ── Format helpers ────────────────────────────────────────────────────────────
const fmt  = v => v == null ? '—' : '£' + Math.round(v).toLocaleString('en-GB');
const esc  = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
const cols = () => S.cols.length;

// ── Render ────────────────────────────────────────────────────────────────────
function render() {
  const yearKey = document.getElementById('taxYear').value;
  const yr = YEARS[yearKey];
  const n = cols();
  const res = S.results; // array | null

  // Update grid column template
  const grid = document.getElementById('grid');
  grid.style.gridTemplateColumns = `var(--label-w) repeat(${n}, var(--col-w))`;

  // Chevron SVG helper
  const chev = (open) =>
    `<svg class="chevron ${open ? 'open' : ''}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>`;

  // Cell builders
  const C = (cls, content, extra='') =>
    `<div class="cell ${cls}" ${extra}>${content}</div>`;

  const lastColClass = (i) => i === n - 1 ? 'no-border-right' : '';
  const lastRowFlag = 'no-border-bottom';

  let h = '';

  // ── Column header row
  h += C('cell-colhead label-col', '');
  for (let i = 0; i < n; i++) {
    const isLast = i === n - 1;
    h += `<div class="cell cell-colhead value-col ${isLast ? 'no-border-right' : ''}">
      <span class="col-num">${n > 1 ? `Option ${String.fromCharCode(65 + i)}` : ''}</span>
      ${n > 1 ? `<button class="btn-danger" onclick="removeCol(${i})" title="Remove column">✕</button>` : ''}
    </div>`;
  }

  // ── Annual salary row
  h += C('cell cell-input label-col', 'Annual Salary');
  for (let i = 0; i < n; i++) {
    h += `<div class="cell cell-input value-col ${lastColClass(i)}">
      <div class="field">
        <span class="field-pfx">£</span>
        <input type="number" min="0" step="1000" placeholder="e.g. 45000"
          value="${esc(S.cols[i].salary)}"
          data-col-input="${i}" data-field="salary"
          oninput="updateCol(${i},'salary',this.value)">
      </div>
    </div>`;
  }

  // ── Tax code row
  h += C('cell cell-input label-col', 'Tax Code');
  for (let i = 0; i < n; i++) {
    h += `<div class="cell cell-input value-col ${lastColClass(i)}">
      <div class="field">
        <input type="text" placeholder="e.g. 1257L" style="text-transform:uppercase"
          value="${esc(S.cols[i].taxCode)}"
          data-col-input="${i}" data-field="taxCode"
          oninput="updateCol(${i},'taxCode',this.value)">
      </div>
    </div>`;
  }

  // ── Income Tax section header (toggle in label col only)
  h += `<div class="cell cell-section label-col" onclick="toggleS('taxOpen')">
    ${chev(S.taxOpen)}
    <span style="font-size:0.8125rem;font-weight:500;color:var(--gray-700)">Income Tax</span>
  </div>`;
  for (let i = 0; i < n; i++) {
    h += C(`cell cell-section value-col ${lastColClass(i)}`, '');
  }

  // ── Tax band rows
  if (S.taxOpen) {
    yr.tax.forEach((b, bi) => {
      h += C('cell cell-taxband label-col', b.label);
      for (let i = 0; i < n; i++) {
        const val = res ? res[i]?.taxBreakdown[bi]?.amount ?? null : null;
        h += C(`cell cell-taxband value-col ${lastColClass(i)}`, res ? fmt(val) : '<span class="result-dash">—</span>');
      }
    });
  }

  // ── Total income tax
  h += C('cell cell-total label-col', 'Total Income Tax');
  for (let i = 0; i < n; i++) {
    h += C(`cell cell-total value-col ${lastColClass(i)}`, res ? fmt(res[i]?.totalTax) : '<span class="result-dash">—</span>');
  }

  // ── NI section header
  h += `<div class="cell cell-section label-col" onclick="toggleS('niOpen')">
    ${chev(S.niOpen)}
    <span style="font-size:0.8125rem;font-weight:500;color:var(--gray-700)">NI Contributions</span>
  </div>`;
  for (let i = 0; i < n; i++) {
    h += C(`cell cell-section value-col ${lastColClass(i)}`, '');
  }

  // ── NI band rows
  if (S.niOpen) {
    yr.ni.forEach((b, bi) => {
      h += C('cell cell-niband label-col', b.label);
      for (let i = 0; i < n; i++) {
        const val = res ? res[i]?.niBreakdown[bi]?.amount ?? null : null;
        h += C(`cell cell-niband value-col ${lastColClass(i)}`, res ? fmt(val) : '<span class="result-dash">—</span>');
      }
    });
  }

  // ── Total NI
  h += C('cell cell-total label-col', 'Total NI');
  for (let i = 0; i < n; i++) {
    h += C(`cell cell-total value-col ni ${lastColClass(i)}`, res ? fmt(res[i]?.totalNI) : '<span class="result-dash">—</span>');
  }

  // ── Take-home annual
  h += C('cell cell-takehome label-col', 'Take-Home Pay');
  for (let i = 0; i < n; i++) {
    h += C(`cell cell-takehome value-col ${lastColClass(i)}`, res ? fmt(res[i]?.takeHome) : '<span class="result-dash">—</span>');
  }

  // ── Take-home monthly (last row — no bottom border)
  h += C(`cell cell-monthly label-col ${lastRowFlag}`, '↳ per month');
  for (let i = 0; i < n; i++) {
    h += C(`cell cell-monthly value-col ${lastColClass(i)} ${lastRowFlag}`, res ? fmt(res[i] ? res[i].takeHome / 12 : null) : '<span class="result-dash">—</span>');
  }

  grid.innerHTML = h;

  // Show/hide add column button in toolbar
  renderToolbar();
}

function renderToolbar() {
  let btn = document.getElementById('addColBtn');
  if (!btn) {
    btn = document.createElement('button');
    btn.id = 'addColBtn';
    btn.className = 'btn btn-outline';
    btn.onclick = addCol;
    document.querySelector('.toolbar').appendChild(btn);
  }
  if (S.cols.length >= MAX_COLS) {
    btn.style.display = 'none';
  } else {
    btn.style.display = '';
    btn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> Add column`;
  }
}

// ── Actions ────────────────────────────────────────────────────────────────────
function setNote(msg, color) {
  const note = document.getElementById('calcNote');
  note.textContent = msg;
  note.style.color = color;
}

function calculate() {
  // Flush any in-progress input values from the DOM into state before calculating,
  // since updateCol() no longer calls render() (to preserve focus).
  document.querySelectorAll('[data-col-input]').forEach(el => {
    const i = +el.dataset.colInput;
    const field = el.dataset.field;
    if (S.cols[i]) S.cols[i][field] = el.value;
  });

  const yearKey = document.getElementById('taxYear').value;
  S.results = S.cols.map(c => {
    const sal = parseFloat(c.salary);
    return isNaN(sal) || sal <= 0 ? null : calcOne(sal, c.taxCode, yearKey);
  });

  const anyValid = S.results.some(r => r !== null);
  if (anyValid) {
    setNote('Results updated.', 'var(--green-600)');
    document.getElementById('grid').classList.add('results-appear');
    setTimeout(() => document.getElementById('grid').classList.remove('results-appear'), 300);
  } else {
    setNote('Please enter at least one annual salary.', 'var(--gray-400)');
  }

  render();
}

function updateCol(i, field, val) {
  S.cols[i][field] = val;
  // Mark results stale — do NOT call render() here, that would destroy the focused input
  if (S.results) {
    S.results = null;
    setNote('Details changed — press Calculate to update.', 'var(--gray-400)');
  }
  // Keep the grid column template in sync (no innerHTML touch needed)
}

function addCol() {
  if (S.cols.length >= MAX_COLS) return;
  S.cols.push({ salary: '', taxCode: '1257L' });
  S.results = null;
  render();
}

function removeCol(i) {
  if (S.cols.length <= 1) return;
  S.cols.splice(i, 1);
  S.results = null;
  render();
}

function toggleS(key) {
  S[key] = !S[key];
  render();
}

// ── Init ───────────────────────────────────────────────────────────────────────
render();
</script>
</body>
</html>
